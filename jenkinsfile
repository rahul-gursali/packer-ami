pipeline {
    agent any

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Install Packer') {
            steps {
                sh '''
                PACKER_VERSION=1.10.7
                curl -Lo packer.zip https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip
                unzip packer.zip
                sudo mv packer /usr/local/bin/
                packer version
                '''
            }
        }

        stage('Packer Init') {
            steps {
                sh "packer init ."
            }
        }

        stage('Validate Template') {
            steps {
                sh "packer validate ."
            }
        }

        stage('Build AMI') {
            steps {
                withCredentials([
                    string(credentialsId: 'aws-region',            variable: 'AWS_REGION'),
                    string(credentialsId: 'aws-access-key-id',     variable: 'AWS_ACCESS_KEY_ID'),
                    string(credentialsId: 'aws-secret-access-key', variable: 'AWS_SECRET_ACCESS_KEY'),
                    string(credentialsId: 'ssh-key-name',          variable: 'SSH_KEY_NAME'),
                    string(credentialsId: 'source-ami',            variable: 'SOURCE_AMI')
                ]) {
                    sh '''
                    packer build \
                      -var "aws_region=${AWS_REGION}" \
                      -var "ssh_key_name=${SSH_KEY_NAME}" \
                      -var "source_ami=${SOURCE_AMI}" \
                      ami.pkr.hcl
                    '''
                }
            }
        }
    }

    post {
        success {
            echo "Packer AMI build completed."
        }
        failure {
            echo "Build failed. Check logs."
        }
    }
}
